---
title: "Validate and load electronic health records"
author: "Peter Dutey"
date: '`r format(Sys.Date(), "%d %B %Y")`'
output: 
  rmarkdown::html_vignette:
   toc: true 
bibliography: ../inst/REFERENCES.bib
always_allow_html: yes
vignette: >
  %\VignetteIndexEntry{Validate and load electronic health records}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(Ramses)
```


## Introduction

This vignette demonstrates how to clean and validate hospital records and load them into a data warehouse.

Ramses is provided with simulated data consisting of records of `r formatC(length(unique(inpatient_episodes$local_provider_spell_number)), big.mark = ",")` hospitalisations for `r formatC(length(unique(inpatient_episodes$local_patient_identifier)), big.mark = ",")` patients, complete with prescriptions, diagnoses and care episodes records.


# Data cleaning and validation
```{r setup, warning=F, message=F}
library(AMR)
library(Ramses)
# to facilitate data manipulations
library(dplyr)
```


## Medication records
### Drug prescriptions

```{r print_prescriptions}
str(drug_prescriptions)
```


We begin by mapping drug concepts thanks to the `as.ab()` function provided by the AMR package. This function takes a character variable as input and returns a three-letter code EARS-Net code. For more information, refer to the documentation for the `as.ab` function. Some manual editing may be required when drugs are not successfully mapped, as shown in the example below.

```{r map_drug_failing}
# attempting to map drug name using AMR package
drug_prescriptions$drug_id <- AMR::as.ab(drug_prescriptions$tr_DESC)
```

```{r map_drug}
# editing drug names
drug_prescriptions$drug_id <- gsub("Vancomycin protocol", 
                                   "Vancomycin",
                                   drug_prescriptions$tr_DESC)
# mapping drug name using AMR package
drug_prescriptions$drug_id <- AMR::as.ab(drug_prescriptions$drug_id)
drug_prescriptions$drug_name <- AMR::ab_name(drug_prescriptions$drug_id)
# recoding route of administration
drug_prescriptions <- mutate(drug_prescriptions, 
  ATC_route = 
    case_when(
      route %in% c(NULL) ~ "Implant", 
      route %in% c("NEB", "INHAL") ~ "Inhal", 
      route %in% c("TOP", "EYE", "EYEL", "EYER", "EYEB", 
                   "EAR", "EARL", "EARR", "EARB") ~ "Instill", 
      route %in% c("NASAL", "NOST", "NOSTL", "NOSTR", "NOSTB") ~ "N", 
      route %in% c("ORAL", "NAS", "PEG") ~ "O", 
      route %in% c("IV", "IVB", "IVI", "IMI", "IT", "IVT") ~ "P", 
      route %in% c("PR") ~ "R", 
      route %in% c("BUCC", "SB", "OROM", "SUBL") ~ "SL", 
      route %in% c("SC", "ID") ~ "TD", 
      route %in% c("PV") ~ "V", 
      TRUE ~ "NA_character_"
    ))
```

With the AMR package, it is possible to infer important properties of the drug:
- its ATC class and group, which can be useful for instance in order identify antifungals (group 'Antifungals/antimycotics')
- Defined Daily Doses (DDDs). 

Working out the DDD of the prescription is somewhat more complex. The reference DDD is for the main substance. In the case of amoxicillin/clavulanic acid for example, the DDD (0.5g) refers to the amoxicillin. A 625mg tablet of Augmentin (c) contains 500mg of amoxicillin and 125mg of clavulanic acid. The reference DDD is `paste0(AMR::ab_ddd("amoxicillin/clavulanic acid", "oral"), AMR::ab_ddd("amoxicillin/clavulanic acid", "oral", unit = T))` = `r paste0(ab_ddd("amoxicillin/clavulanic acid", "oral"), ab_ddd("amoxicillin/clavulanic acid", "oral", unit = T))`. A prescription of Augmentin 625mg TDS (three times a day) therefore amounts to 1.5g of amoxicillin per day, which is 1.5 DDDs. Co-trimoxazole is a compound of 5 parts of sulfamethoxazole to 1 part of trimethoprim. The DDD of sulfamethoxazole is 2g while the DDD of trimethoprim is 400mg: with this ratio of 5 to 1, DDDs calculated on the basis of the dosage of sulfamethoxazole will be valid for co-trimoxazole prepared with 5 parts to 1 part.

These just some examples. In order to obtain the correct DDDs for compound medications, it is recommended to map data to a suitable dictionary of medicines such as the [RxNorm](http://bioportal.bioontology.org/ontologies/RXNORM) or the [NHS Dictionary of Drugs and Medical Devices (dm+d)](https://www.nhsbsa.nhs.uk/pharmacies-gp-practices-and-appliance-contractors/dictionary-medicines-and-devices-dmd) and extract the relevant strengths.

In this example, however, we use a look-up table for the strength of compound medications. Another lookup table `reference_drug_frequency` available within Ramses is also used to convert the `frequency` character variable into a numeric variable indicating the daily frequency of administration. 

```{r compute_ddd}
# extracting the ATC code (eg J01CR02) group (eg Beta-lactam antibacterials, penicillins)
drug_prescriptions$ATC_code <- AMR::ab_atc(drug_prescriptions$drug_id)
drug_prescriptions$ATC_group <- AMR::ab_atc_group1(drug_prescriptions$drug_id)
# removing antifungal drug, if applicable
drug_prescriptions <- filter(drug_prescriptions, 
                             ATC_group != "Antimycotics for systemic use")

# prepare DDD extraction
compound_strength_lookup <- data.frame(list(
  drug_id = c("AMC", "AMC", "TZP", "SMX"),
  route = c("oral", "oral", "oral", "oral"),
  dose = c(625, 1.2, 4.5, 480),
  units = c("mg", "g", "g", "mg"),
  strength = c(500, 1, 4, 400),
  basis_of_strength = c("AMX", "AMX", "PIP", "SMX")
), stringsAsFactors = F)

drug_prescriptions <- merge(drug_prescriptions, 
                            compound_strength_lookup, 
                            all.x = T)
drug_prescriptions <- drug_prescriptions %>% 
  mutate(strength = if_else(is.na(strength), dose, strength),  
         basis_of_strength = if_else(is.na(basis_of_strength),
                                     as.character(drug_id),
                                     basis_of_strength))

drug_prescriptions <- merge(drug_prescriptions, 
                            reference_drug_frequency, by = "frequency", all.x = T)

# computing the prescription DDD the reference DDD from the ATC
drug_prescriptions <- drug_prescriptions %>% 
  mutate(daily_dose = strength * daily_frequency) %>% 
  mutate(DDD = compute_DDDs(
    ATC_code = AMR::ab_atc(basis_of_strength),
    ATC_administration = ATC_route,
    dose = daily_dose,
    unit = units))

```

### Drug administrations

An identical process is followed for drug administration, with the difference that DDDs do not rely on a daily frequency of administration variable

```{r prepare_drug_admin}
drug_administrations$drug_id <- gsub("Vancomycin protocol", 
                                     "Vancomycin", 
                                     drug_administrations$tr_DESC)
drug_administrations$drug_id <- AMR::as.ab(drug_administrations$drug_id)
drug_administrations$drug_name <- AMR::ab_name(drug_administrations$drug_id)
# recoding route of administration
drug_administrations <- mutate(drug_administrations, 
  ATC_route = 
    case_when(
      route %in% c(NULL) ~ "Implant", 
      route %in% c("NEB", "INHAL") ~ "Inhal", 
      route %in% c("TOP", "EYE", "EYEL", "EYER", "EYEB", 
                   "EAR", "EARL", "EARR", "EARB") ~ "Instill", 
      route %in% c("NASAL", "NOST", "NOSTL", "NOSTR", "NOSTB") ~ "N", 
      route %in% c("ORAL", "NAS", "PEG") ~ "O", 
      route %in% c("IV", "IVB", "IVI", "IMI", "IT", "IVT") ~ "P", 
      route %in% c("PR") ~ "R", 
      route %in% c("BUCC", "SB", "OROM", "SUBL") ~ "SL", 
      route %in% c("SC", "ID") ~ "TD", 
      route %in% c("PV") ~ "V", 
      TRUE ~ "NA_character_"
    ))
drug_administrations$ATC_code <- AMR::ab_atc(drug_administrations$drug_id)
drug_administrations$ATC_group <- AMR::ab_atc_group1(drug_administrations$drug_id)
drug_administrations <- filter(drug_administrations, 
                               ATC_group != "Antimycotics for systemic use")

drug_administrations <- merge(drug_administrations, compound_strength_lookup, all.x = T)
drug_administrations <- drug_administrations %>% 
  mutate(strength = if_else(is.na(strength), dose, strength),
         basis_of_strength = if_else(is.na(basis_of_strength),
                                     as.character(drug_id),
                                     basis_of_strength))

drug_administrations <- drug_administrations %>% 
  mutate(DDD = compute_DDDs(
    ATC_code = AMR::ab_atc(basis_of_strength),
    ATC_administration = ATC_route,
    dose = dose,
    unit = units 
  )) 

# Create an identifier
# Note: An alternative is encryption using openssl::sha256()
      
drug_administrations$administration_id <- drug_administrations %>%
  dplyr::group_indices(
    patient_id,
    drug_id,
    route,
    dose,
    units,
    administration_date)

drug_administrations <- drug_administrations %>% 
    transmute(
      patient_id,
      administration_id = as.character(administration_id),
      prescription_id,
      administration_text = paste0(
          drug_name, " ", route, " ", dose, units),
      drug_id,
      drug_name,
      drug_display_name = drug_name,
      ATC_code,
      ATC_group,
      ATC_route,
      dose,
      unit = units,
      route,
      administration_date,
      administration_status = "completed",
      DDD
    )



```

## Inpatient care records

### Episodes of care


### Diagnosis codes (ICD-10)

In order to exploit clinical diagnoses coded by doctors during hospital admissions, Ramses relies on a range of look up tables which must be built to suit the precise ICD-10 version used by the data. Ramses uses three types of look up tables:

* an ICD-10 reference table containing all ICD-10 codes, their full-text description, and chapter headings
* a categorisation based on the AHRQ Clinical Classification Software (CCS) or its Revised version (CCSR)
* a classification of infections and whether antibiotics are commonly indicated to treat them, adapted from @Hashimoto2020

### ICD-10 reference table

This example uses the `Ramses::inpatient_diagnoses` example dataset. First, we download the ICD-10-CM reference look up table

```{r}
icd10cm <- download_icd10cm()
str(icd10cm)
```

We verify that all ICD-10 codes in the dataset can be mapped to the reference table.
The first validation fails, because some of the `icd_code` in `inpatient_diagnoses` are missing (all diagnoses that are not infections). These are removed before validation is attempted again. In the present example, the dataset is simulated using ICD-10 5th Edition, rather than ICD-10-CM. The match is therefore not complete on the second validation attempt. Although the validation produces a warning, it passes (returns `TRUE`). This means it will not prevent loading the data into the warehouse.

```{r diagnoses_first_valid_attempt}
validate_inpatient_diagnoses(inpatient_diagnoses, icd10cm)
```
```{r diagnoses_second_valid_attempt}
inpatient_diagnoses <- filter(inpatient_diagnoses, !is.na(icd_code))
validate_inpatient_diagnoses(inpatient_diagnoses, icd10cm)
```


Next, we classify the reference look up table to other classifications:

- \link[common infections and indications]{antibiotic_icd_indications} for antibiotic prescribing
- Charlson Comorbidity Index weights
- Clinical Classifications Software (CCS)
- Clinical Classifications Software Refined (CCSR)

Although this is done automatically when loading diagnoses into the warehouse, this step can be useful to first check that the ICD-10 reference table is successfully mapped to other classifications. 

```{r}
icd_infection_lkup <- icd10cm %>% 
  select(icd_code) %>% 
  map_infections_abx_indications(df = ., icd_column = "icd_code")

comorbidity_lkup <- icd10cm %>% 
  select(icd_code) %>% 
  map_charlson_comorbidities(df = ., icd_column = "icd_code")

ccsr_lkup <- icd10cm %>% 
  select(icd_code) %>% 
  map_ICD10_CCSR(df = ., icd_column = "icd_code")

ccs_lkup <- icd10cm %>% 
  select(icd_code) %>% 
  map_ICD10_CCS(df = ., icd_column = "icd_code")

head(icd_infection_lkup)
```


```{r create_local_db}
ramses_db <- connect_db_local("ramses-db.sqlite")
load_inpatient_diagnoses(conn = ramses_db, 
                         diagnoses_data = inpatient_diagnoses, 
                         diagnoses_lookup = icd10cm, 
                         overwrite = TRUE)

# TODO: APC_Diagnoses_Infection_Summary
```


```{r load_medications}
# load aware - add atc and ATC_route
# create TTA
drug_prescriptions <- drug_prescriptions %>% 
  transmute(patient_id,
            prescription_id,
            drug_id,
            drug_name = drug_name,
            drug_display_name = drug_name,
            ATC_code,
            ATC_group,
            ATC_route,
            authoring_date,
            prescription_start,
            prescription_end,
            prescription_status = "completed",
            prescription_context = "inpatient",
            dose,
            unit = units,
            route,
            frequency,
            daily_frequency,
            DDD)

load_medications(conn = ramses_db, 
                 prescriptions = drug_prescriptions, 
                 administrations = drug_administrations, 
                 overwrite = TRUE)

load_inpatient_episodes(conn = ramses_db,
                        episodes_data = Ramses::inpatient_episodes,
                        wards_data =  Ramses::inpatient_wards)


```


You are now able to visualise the data!
```{r}
therapy_timeline(ramses_db, patient_identifier =  "1253675584")
DBI::dbDisconnect(ramses_db)
```


# References